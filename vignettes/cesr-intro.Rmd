---
title: "cesr - Calculating trends from CES data"
author: "Rob Robinson"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: rmarkdown::html_vignette
#output: rmarkdown::pdf_document
urlcolor: blue
vignette: >
  %\VignetteIndexEntry{cesr-intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Background

The use of marked individuals to study animal populations has a long history in ecology and bird ringing has played a central role in this history.  Although many early bird ringing studies were largely concerned with studying site fidelity and migration, attention soon shifted to estimating population size and changes in this over time (Baillie 1990, 2001; DeSante _et al._ 1995).  Three vital rates drive population change: birth rate (productivity), survival (or mortality) rate and, when the study population is a subset of a larger one, dispersal (immigration/emigration) rates.  Monitoring of these vital rates (demographic monitoring) shifts focus from the population pattern to the underlying process and should provide greater accuracy and sensitivity in detecting impacts of environmental change. Demographic monitoring of many bird species can be effectively accomplished with bird ringing.  Indeed, application of capture-recapture models to bird ringing data is the only reliable method of obtaining estimates of survival and dispersal in wild bird populations.  By using standard field methods and capture effort of bird-ringing studies among sites and between years, calculating vital rates, and changes in them, becomes much easier as variation due to differences in catchability of individuals is much reduced. Such standardisation provides the basis of national and international constant-effort (CE) ringing programmes (Robinson _et al._ 2009).  

In Britain, CE ringing as a means of monitoring bird populations began in the late 1960's when ringers, mostly unpaid volunteers, began to consider how to increase the value of their ringing; standardising mist-netting effort was one obvious way in which to do so. In the late 1970's a national CE scheme was proposed, and the CE Sites (CES) scheme was formally adopted as part of the BTO's Integrated Population Monitoring Programme in 1986 (Peach _et al._ 1996).  Subsequently, CE ringing schemes started in at least 15 European countries (co-ordinated through EURING) and in North America. At around the same time as CE ringing was being developed in Britain, a scheme was initiated in Germany/Austria at three sites (Mettnau, Reit and Illmitz, MRI) using year-round CE ringing and provided some of the first evidence for declines in migratory bird populations (Berthold _et al._ 1986). 

CE programmes can operate at large spatial scales because they rely heavily on volunteer input and so can gather detailed demographic data in a cost-effective way. Such programmes aim to fulfill three complementary and inter-linked goals:

1. Monitoring - to provide long-term estimates or indices of abundance, productivity and survival in a range of common species, usually in concert with other monitoring schemes.

1. Research - to investigate the contribution of different demographic rates in determining population dynamics and their relationship with various ecological and environmental drivers.

1. Management - to understand how habitat may best be managed in conserving local populations.

CE capture-recapture data fulfill these goals by providing information on productivity; recruitment, i.e., number of new adult birds entering the breeding population, and adult survival.  Because recruitment combines aspects of both productivity and over-winter survival of first-year birds, by examining patterns of recruitment, survival, and productivity measured at the same set of sites, we gain unique insights into the relative importance of drivers acting on each of the different life-cycle stages in determining population change (Julliard 2004; Saracco _et al._ 2008).  This can be essential for designing conservation and management plans that can reverse population declines and maintain healthy populations as it identifies the key stages affecting population change and narrows the range of environmental factors to be considered; data from CE sites have been, and will continue to be, critical in this regard.

## What is cesr?

cesr provides tools to perform basic analyses of annual variation in abundance, survival and productivity which are suitable for simple monitoring purposes, it cannot provide a full suite of methods to do a complete analysis of all CES data. It is a collection of tools designed to be used with the statistics package R. R has a number of advantages for statistical analysis: it is easy to introduce new analyses to it; it has good options for summarising and plotting data; and best of all, it is free. 

## Before you start ...
To use cesr you first need to download and install R (if it is not already installed on your computer). To do this you need to go to [R homepage](https://cloud.r-project.org/) and click on the 'download R' link for your system. There are many guides to using R, some are easy to understand, others are highly technical and less easy to understand. Good places to start is the [introductory guide](http://cran.r-project.org/doc/manuals/R-intro.pdf) available on the R website, which gives a few basic commands, and the [quick-R](https://www.statmethods.net/r-tutorial/index.html) website. For those who want to undertake some statistical analyses, Mick Crawley has written a good introduction^[Crawley, M. (2005) Statistics: an introduction using R. Wiley-Blackwell, London.] , while his _R Book_^[Crawley, M. (2007). The R book. Wiley-Blackwell, London.] is quite comprehensive. For those who need more technical details on doing high-level analysis, these books^[Try Bolker (2008) or Zuur _et al._ (2007), both of which use ecology examples, or Venables & Ripley (2002), which is more general; Wood (2006) is more advanced but explains the background statistics well] offer good explanations. If you intend to use R a lot, do have a look at the [RStudio](https://www.rstudio.org) software which provides a nice environment for writing and developing R code.

The basic R program allows you to do many things, but not everything. The beauty of the R system is that people can contribute 'packages' (cesr is one) that add specific extra functionality to the base system. The cesr package is now available for download and you can install it with the following R commands:
```{r, eval=FALSE}
install.packages('remotes')
remotes::install_github("btorobrob/cesr")
```
These slightly cryptic commands simply goes to my account (btorobrob) on Github and gets the cesr package (and the code to do this doesn't come automatically with R)^[You can safely ignore the warning about RTools not being installed. R users who have the devtools package already installed can use the function of the same name in that package]. Don't worry, you only need to do this  once, unless you change computer, update R, or you want to update the cesr package itself. This should also download all the extra packages cesr needs (notably data.table to speed up the data extraction and RMark for the survival analysis) so you may see some text whizzing by on the screen. 
Each time you start R, you will need to load, or 'attach', the cesr package (there are many thousands of packages to do all sorts of different analyses, so for efficiency R only loads those you actually want to use). Do this using
```{r}
library(cesr)
```
You should get the brief welcome message telling you which version of the package you are using.

**One important thing to remember.** You can do very little harm by getting things wrong, if you get in a mess just close R down and start again. 

R will usually tell you what it thinks has gone wrong. You might (will) encounter two types of messages: 'errors' and 'warnings'. Errors are usually serious enough that R will stop what it is doing and you will need to fix the problem. Warnings arise when it is unsure how to proceed, but it can make a guess and carry on; sometimes it gets it right, others not. You are *strongly* advised to understand why the warning was issued and what R has done to fix the issue. Even though calculations are proceeding, bad things can ensue! The messages R gives are intended to be helpful, but can be quite cryptic, especially if you are unfamiliar with how it works. I've tried to translate the commonest ones, if you come across others copy and paste the error message from the R window _and_ the command you used which generated it into an email to me; I'll see if I can help.

## A sample session

There are essentially four steps necessary to analyse CES data (or indeed any other data) in R: first, one needs to get all the data into a form that is ready for analysis; one then needs to select and extract the data for the species of interest; then the analysis can be performed; finally, you will wish to output the results of the analysis, perhaps for publication in an annual report or on a webpage. Additionally, it can also be useful to plot and summarise different sets of data, both to reveal patterns and to check that mistakes have not been made. 

The cesr package is arranged around these four tasks and provides functions to perform each of them. A 'function' in R is simply a command to tell R to perform certain tasks. In order to complete these tasks they normally need to be given some information saying, for example, where it may find the data to use - these are included in parentheses '( )' and each of these is called an 'argument'. If a function requires more than one argument, those given after the first are usually named (e.g. species=10990), which means they can be given in any order. So the very simplest cesr analysis might look like:
```{r, eval=FALSE}
library(cesr)
setwd('d:/CESdata/')
cesdata = readces('filename')
ces.sites = extract.coverage(cesdata, min.visits=8)
robin.data = extract.data(cesdata, species=10990, plots=ces.sites)
result = index(robin.data)
plot.trend(result, type='adult', file='robin_ad.png')
```

The first line simply loads the cesr package into R. The second line (shorthand for 'set working directory') points R to the folder where your CES data are stored and where you can write the graph images to. The next line reads a datafile of CES captures and assigns it to an object called 'cesdata' . An object in R can be thought of as a mini-spreadsheet; normally it will contain some rows of data (an individual capture of a bird in this case) with some columns, each of which contains a particular variable (for example the date of capture, ring number, species type, sex, etc). The next two lines extract the specific data necessary for analyses, the years in which each site was covered (put into 'ces.sites'), and the data on captures for a particular species (to be found in 'robin.data'). Then we are ready to do the analysis with the function index(). Note that we need to tell index() where to find the data containing the species information (the object robin.data) and the site coverage information (the object ces.sites). This stores indices of the annual abundance and productivity in the object 'result' and provides some summary output about the model fit to the screen. The final line creates a graph of the annual trend in a form that can be used in publications. 

Of course the package can do a bit more than this, and the rest of this document will show the range of tools available, and how to use them. If you need any more information or are just plain confused about what things do at any point, try typing help(function_name). The nice thing about R is that you can save these commands as a simple text file (usually with a '.R' extension) which means you can easily re-run them, or adapt them if you want to do a slightly different analysis (say for a different species, just copy the code and change the Euring number and species names). Getting into the habit of saving code files is a good one, especially if you might later want to re-run the analysis, or simply remember what you did! 

Incidentally, in books about R, you will sometimes see an '=' used to assign an object and sometimes a '<-' (a left-bracket, followed by a hypen), for almost all purposes they are interchangeable, so I will continue to use the '=', feel free to substitute the '<-' in your own code. Note also that R is **case sensitive**, so, for example, the variables 'netlength' and 'NetLength' are not the same; in most cases you should use only lower case for typing, since R may not recognise your commands otherwise. On a similar note, if you start a line with a hash sign ('#') then R will ignore the rest of the line; this can be useful to add comments to your code explaining to future-you why you did things in a particular way. A good general rule is to use more comments than you think necessary - experience has taught me that future-you will thank you as you try and figure out what you did and why in several months (or years!) time.

## Data Preparation

The package comes with some sample data from Britain for Robin _Erithacus rubecula_ and  Song Thrush _Turdus philomelos_ which we will use to demonstrate the use of this package. Often the hardest part in any analysis is often getting the data in a form that is suitable for analysis, consequently, cesr expects to get the data in a particular format. In an effort to reduce the options for things going wrong, most of the functions in the package require an object belonging the ces 'class'. These are generated automatically by the functions, so in most cases you don't need to worry about it, it just ensures all the necessary information is available and in the correct format. Because of this, to avoid problems later on, it is strongly recommended that you format your data correctly [guidelines here](https://euring.org/research/ces-europe/methods/data-format-euroces) and read it in using the readces() function, which sets up the correct variables. If you use another method (e.g. read.csv()), even if the data are in the right format, R should tell you don't have 'a CES object'; expect all kinds of pain if you persist!

Your file should be a comma-separated plain text file with all the data for every species caught by one scheme in one file. Schemes should screen the data for appropriate sites and years to use and all ringing additional to the standard CES effort (either extra nets or visits) should be excluded, i.e. the data should be ready to use as is. Each row should represent the capture of one bird on a particular day, thus an individual bird may appear on multiple rows, both on different dates within the same year and if it is recaptured in subsequent years. The first row should be column identifiers, and all birds should be included even if they include missing data (for example, birds that are unaged, that is Euring age-code 0 or 2). 

The first few lines could look a bit like this:
```
countryID,Site,coords,habitat,visit,day,month,year,NetLength,scheme,ring_number,species,sex,age
ES,E001,+425200-0023200,WS,6,17,07,2010,132,ESA,B....90916,11870,M,4
ES,E001,+425200-0023200,WS,1,01,05,2010,132,ESA,B....90926,11870,F,4
```


## Reading in the data

Before you start, remember to load the cesr package
```{r, eval=FALSE}
library(cesr)
```

It is likely to be simpler if you keep a particular folder/directory for your data file and results. The first thing to do, then, is tell R which folder this is using the command to set the working directory:
```{r, eval=FALSE}
setwd('d:/data/ces')
```
where 'd:/data/ces' represents the path to your folder^[If you are using Windows, note that R uses a forward slash '/' to separate directory levels rather than the usual backslash '\'.] With a datafile prepared in the correct format and copied into this folder it is easy to get the data into R, we will put it into an object called ukdata, but you can choose whatever name you like:
```{r, eval=FALSE}
ukdata = readces('ukdata.csv')
```
If you have already set the working directory (above) and the file is in there, you only need to give the filename; if not, you will need to give the full path name (for example, 'd:/data/ces/ukdata.csv'). If this works correctly, R will read the data in silently and just give you the next prompt. It will do some basic checks of the data (e.g. for invalid age codes) and do it's best to warn you of any problems it finds.

If you want to follow along with the example data set, just type
```{r}
data(ukdata)
```
since these data have already been read in and saved in 'R format'.

Note, if you do not tell it otherwise, R will use scientific names for species. To make things easier it is possible to choose which language R will report species names, for example:
```{r}
setceslang('English')
```
The allowable choices currently are 'Danish', 'Dutch', 'English', 'Finnish', 'French', 'German', 'Italian', 'Norwegian', 'Polish', 'Portuguese', 'Spanish' and 'Swedish'. Note the capitals and the use of quotes. In general it does not matter whether you use single (' ') or double (" ") quotes, but do not use backquotes (` `). For rarer species, names may not be available, in this case the EURING number will be given; it may be wise to check these EURING numbers to ensure that they have been entered into the data file correctly.

## Checking the data

First, to check the data have loaded correctly we can ask for a summary of the data:
```{r}
summary(ukdata)
```
Thus, in our example dataset, we have capture data on 3,737 individuals of two species. You can use summary() on any CES object to get an idea of what it contains. 

Although it may not be obvious from this, R will normally list species in taxonomic ("Voous") order; that is in order of the EURING code number. You can change this by using the sp.order argument:
```{r, eval=FALSE}
summary(ukdata, sp.order='count')
```
this will list species in descending order of the number of captures, you can list species alphabetically using sp.order='alpha', though both of these will give the same result in our case! You can also check how many young birds were caught:
```{r}
summary(ukdata, age=3, sp.order='count')
```
and similarly, how many adult birds by using age=4. Note, in general, the first argument is always the CES data object. It is best to include the name of the remaining arguments, in which case it does not matter in which order they are given.  

If we wish to look a bit more closely at the data we have read in, then two commands may be helpful. The first:
```{r}
head(ukdata, n=4)
```
shows the first _n_ lines of data, while the second:
```{r}
summary(ukdata, df=TRUE)
```
gives a summary of each variable. Note there are two ways in which variables are summarised: for numeric variables it gives, the minimum, quartile, median and maximum values; for character variables it gives a frequency count of the commonest entries. Note also that _cesr_ has done a little bit of re-arranging of the data, so the columns are not quite the same as those required to be read in!

As with summary(), all CES objects can be 'plot'ted, which will give a graphical summary of the information therein, So:
```{r, fig.dim = c(5, 5), fig.align='center'}
plot(ukdata)
```	
The top left graph shows the total number of records by species for each year. The top right graph, the mean number of captures (across the years) in each visit period, the bars give the inter-quartile range (i.e. encompassing 25% - 75% of the annual values). The bottom graph gives the mean number of captures by species (only 2 in our data set!) and site (note not all the site labels are printed here). 

Normally, we will want to analyse the whole dataset to produce a national trend, but sometimes we may want to look at only a single site, or a group of sites representing a particular region or habitat. There is a function select.data() to do this. To use this function we first need to create a list of sites to be selected. The best way to do this is by using the in-built R function c(), which simply creates (or collects) a list of numbers. In our sample dataset we may want to include only those sites that were operated in each of the eight years, so we might type:
```{r, eval=FALSE}
sitelist = c(401, 403, 405, 407, 408, 414, 417, 447, 463)
```
we can then select just those sites using:
```{r, eval=FALSE}
ukcomplete = select.data(ukdata, sites=sitelist)
```

We have created a copy of the data (ukcomplete) so we can go back to the original dataset (ukdata) at any time. It is important to note that if your site codes include a combination of letters and numbers, you will have to enclose each site in the list in quotes, like this:
```{r, eval=FALSE}
sitelist = c('C01', 'C03', 'C05')
```
Because habitat is a particularly important variable, we can select for this directly: 
```{r, eval=FALSE}
ukdata_scrub = select.data(ukdata, habitat='DS')
```
if we wanted only dry/thorn scrub sites; other habitats can be selected in the same way using the two-letter codes listed in Table 1. Selection of birds by age will happen a bit later on, for the moment we just select the sites of interest. Of course, more experienced R users can subset the data directly if necessary, which provides more flexibility than this simple method.

## Extracting the data

Having got just the data we want in the right format, it is now time to extract the information we need to do our analysis. First, we have to identify which sites were operated in which years , then we need to extract the data for the species we are interested in. We only need to extract the site data once, then we can look at as many species as we like. To extract the site coverage from all the UK data, which we will put in an object called uk_sites, type:
```{r}
uk_sites = extract.coverage(ukdata, early=c(6,4), late=c(6,4), all.visits=12)
```
we should specify (using all.visits) how many visits the protocol requires (in the UK case 12, one every ten days or so through the season). Note R tries to warn you if it thinks something is amiss. In this case it has detected a large number of missing visits, this is because we are only dealing with a subset of the real data, but it is usually worth investigating what has caused the warning to check everything is as it should be.

Most adults will tend to be caught earlier in the season (as they disperse after breeding), while most juveniles will tend to be caught later in the season. Thus an additional constraint can be imposed in that a certain number (y) of the first x visits, and similarly of later visits, should also be made. This can be specified using early=c(x,y), and similarly late=c(x,y). This has the added advantage that if a site is only covered in the early period of the year, say, it can still be used for calculating adult abundance. So, in the UK example, four of first six visits must be covered early=c(6,4), and four of the last six visits late=c(6,4). Note that the early and late period may overlap (particularly if your season has an odd number of visits), it doesn't affect the totals, only whether a site is included in the analysis or not. A simpler alternative is to just require a certain number of visits irrespective of timing (especially in those countries where the season has fewer visits in total), just replace the early= and late= arguments with min.visits=n, where n is the minimum of visits required, for example:
```{r, eval=FALSE}
sites = extract.coverage(ukdata, min.visits=8, all.visits=12)
```
As before we can check this has worked by looking at a summary of the data and seeing that all is as expected:
```{r}
summary(uk_sites)
```
Thus we have 19 sites operated in the eight years for which we have data, of which 8 have operated for all eight years and one has only operated for two years. Those who are paying close attention might ask why only 8, when we listed 9 above? The answer is that only 1 visit was made to site 447 in 2007, so although birds were caught there, it doesn't count. We can see similar summary information by using the plot() command.
```{r, fig.dim = c(5, 5), fig.align='center'}
plot(uk_sites)
```
The figure has four panels, the top two illustrate the frequency of sites in each year, and the number of years that sites have run. The bottom two illustrate the evolution of sites contributing to the scheme, that is the cumulative number of sites that have started operating by each year^[In our abbreviated example, 16 sites started in 2001, and the remaining three in 2002, the second year, so the graph is not terribly informative!] and the cumulative number of sites operated for a certain number of years. In our example, six sites have operated for six years or fewer and eight sites for all eight years. 

Finally, we might want to plot a map of where our sites are, we can do this using the map.ces() command. To plot a map simply use:
```{r, echo=FALSE}
library(maps)
```
```{r, fig.dim = c(7,5), fig.align='center'}
map.ces(ukdata) 
```
If you give a filename, R will print the map to a file for later use^[the format will be determined by the file extension; '.jpg', '.tif' or '.pdf' will also work], if not, it will simply print it to the screen. If you are using these maps in publications then you may wish to specify the size (in pixels) by also using the height= and width= arguments^[More detailed maps are possible using the maprec package, or other R map plotting packages]; the size otherwise will be 640 by 480 pixels. Unless you say otherwise, the sites will be plotted onto a map of Europe, to zoom into a smaller area use the xlim= and ylim= arguments to specify longitude and latitude bounds respectively^[if R tries to 'prettify' these too much try using lforce='e', which asks it to use those 'e'xact limits]. For example, this will draw a map of Britain and Ireland:
```{r, eval=FALSE}
map.ces(uk_sites, xlim=c(-10,2), ylim=c(50,60), file='sitemap.png') 
```
Note the use of c() again to concatenate the minimum and maximum bounds into one R object. In this case, sites are identified as current (red) or no longer operating (white), you can also colour sites by the number of years they have operated (use type='n') or habitat (type='h'), in which case you can specify up to 4 colours using the col=c(...) argument. For more details, use help(map.ces) or its shorthand ?map.ces; these, of course, work for almost all R functions.

Having extracted the site coverage data, we can now extract the species data using extract.data(). Normally, we will want to extract data for both adults and juveniles together, but if for some reason just one of these is needed, then you can use the age= argument (where age may be either 3 for juveniles of 4 for adults). To extract the Robin data from our ukdata object we would type:
```{r}
robin.dat = extract.data(ukdata, species=10990, plots=uk_sites)
```
Note that we use the Euring code number to tell R which species we want, and the plots argument inform it about which sites are covered and which we extracted earlier. The Robin data are now in the robin.dat object. As before we can see a summary of these data using:
```{r}
summary(robin.dat)
```
As you can see, when we do this R gives some basic summary information about how many individuals have been caught. It is worth checking that these are what you expected.

We can also get some summary plots of the data 
```{r, fig.dim = c(5,5), fig.align='center'}
plot(robin.dat)
```
This will again give four graphs, the top two give the number of adult and juvenile birds caught in each year. The grey bars represent those actually caught, the black tops to the bars represent the additional number of birds that would have been caught on the missed visits. In the bottom two graphs, sites are ranked (from highest to lowest) by the number of birds caught and the total number of birds caught on sites of that rank or greater is plotted. This gives an indication of how birds are distributed across sites: if a few birds are caught at many sites, the graph will look more like a straight line (each site catches a similar number of birds so adding each site causes a roughly increase), if many birds are caught at a few sites (as might be the case for a habitat specialist like Reed Warbler _Acrocephalus scirpaceus_) the line will increase steeply before flattening out.  

## Indices of Abundance and Productivity

Now that we have all the data in place, we can calculate annual indices of abundance and productivity at the same time using:
```{r}
robin.res = index(robin.dat)
```
Assuming data for both adults and juveniles were extracted with extract.data() then index will analyse both adult and juvenile abundances and productivity (the ratio of juvenile to adult birds caught, see below) and produce a simple summary of the results for each. The change values are just that, so the number of adult robins caught increased by nearly 30%, whereas the number of juveniles caught decreased by (very nearly) 20%. The dispersion parameter (calculated by dividing the deviance by the degrees of freedom) is a quick way of assessing how well the model we have fitted fits our data, if the model fit is good then it should approximately equal 1, though values of up to 2 or 3 are acceptable; for more details, see the description about the models fitted below^[not yet written!]. You will also see printed the change between the first and last years for which there are data. Note, unless you say otherwise, the function will attempt to correct for missing visits using the standard BTO method (see Peach _et al._ 1996; Robinson _et al._ 2007), if you do not want this you can use the argument visit.corr:
```{r, eval=FALSE}
robin.res = index(robin.dat, visit.corr=FALSE)
```
From analyses of BTO data, it seems that the typical level of missing visits (at least in Britain) makes relatively little difference to the final indices in any case (Miles _et al._ 2007; Cave _et al._ 2009).

For a quick look at the annual indices from these models, simply type:
```{r, fig.dim = c(5,6), fig.align='center'}
plot(robin.res)
```
which should yield two columns of, probably, three plots (assuming you extracted data for both adult and juvenile birds, otherwise fewer will be presented). In this view the graphs down the left-hand side (and probably most useful) are plots of the annual indices, those down the right-hand side, the actual (transformed) parameter indices from the fitted model, in almost all cases though the pattern through the years will look similar.

In most cases, however, we will be interested in producing a graph of a particular trend for inclusion in a paper or presentation. To do this, use the plot.trend() command and specify which trend you wish to plot and, optionally, a filename, thus:
```{r, fig.dim = c(5,5), fig.align='center'}
plot.trend(robin.res, type='adult')
```
will print a simple graph showing the annual variation in adult abundance index to the file "adults.png". To get a similar graph for the number of juveniles use graph='juvenile' and for the productivity index, use graph='productivity'; you can shorten these to just the first letter ('a', 'j', or 'p') if you wish. Use "file=" to send the graph to a file with an appropriate extension^['.jpg', '.png', '.pdf', '.svg' should all work]. The graph produced is quite a simple one, but you can tweak various aspects by using standard R arguments. For example, to change the colour of the lines, use add lcol='...' (where ... is the name of a colour, e.g. lcol='red'); to change the thickness use lwd=x; to change the y-axis title (perhaps to something in a non-English language) by using ylab='...'); see the helpfile for all the options. 

For those who are used to drawing graphs in R, plot.trend() returns a dataframe which can be captured into an object:
```{r, fig.keep='none'}
robin.trend = plot.trend(robin.res, type='adult')
```
This has six columns, the models parameter estimates (and their standard errors) and the annual index values (with lower and upper confidence limits). So, for example
```{r}
head(robin.trend) 
```
These can then be plotted using the any of the R plotting tools, or "copy and pasted" into a spreadsheet like Microsoft's Excel or OpenOffice's Calc and a graph drawn there (hint: you may find the 'Text to Columns' tool useful). 

You will note in the graph that the final year is set 1. This is because we can only estimate an index of abundance, not actual abundance, and all the annual indices are relative to a given year. You may prefer to have the trend starting at 1, rather than finishing at 1, this easy to do:
```{r, fig.dim = c(5,5), fig.align='center'}
robin.res = index(robin.dat, year=2001)
plot.trend(robin.res, type='a')
```
The results are the same as before, only the graph is 'shifted-up' the y-axis. Note that you can abbreviate the graph type to just the first letter if you wish. 

Clearly, Robin abundance varies between years, but are these differences significant? One quick visual check can be done by looking for overlapping confidence intervals. You can check whether any year is different from the reference year just by looking to see whether the confidence limits overlap 1, either graphically, or by inspecting robin.res (as it is called in this case). But what if you wish to look between years other than the reference year? Looking for overlap in the 95% confidence limits will result in too stringent a test, Payton _et al._ (2003) showed that actually the 83% confidence intervals will overlap with a probability of (approximately) 0.05. We can get these using the cl= argument
```{r, fig.dim = c(5,5), fig.align='center'}
robin.res83 = index(robin.dat, year=2001, cl=0.83)
robin.trend = plot.trend(robin.res83, type='a')
```
and again looking at the graph, or by typing robin.trend to look at a table of the annual estimates. This suggests, for example, that numbers in 2007/08 on these sites were significantly higher than in 2001/02 (the lower confidence limit, lcl, for 2007/08 is greater than the upper confidence limit, ucl, for 2001/02), but not other years (note this will be slightly sensitive to which year is set as the reference year). If you are doing multiple analyses, you can check which limits have been used by typing:
```{r}
robin.res83$limits
```
though in this case it should be obvious from the name.

More commonly, you might want to check whether this year's results are higher (or lower) than over some previous time period (say the last five years) or whether there is a trend over time. You can use index() to do this too. To look at a (linear) time trend, use the trend= argument, for example:
```{r}
robin.trend = index(robin.dat, trend=8, year=2005)
```
In this case we have asked for the trend to be calculated over our entire time-series (8 years from 2001-08), you can estimate the trend over a shorter period (working back from the current year) by entering a smaller number. Note you can still set the reference year to be any year (here we've set it to 2005, roughly halfway through the period, try plotting the adult and juvenile trends in robin.trend and see what they look like). To compare this year's results to the previous n years, use compare=n instead of trend=n.
```{r}
robin.compare = index(robin.dat, compare=3)
```
index() also calculates a measure of productivity from the ratio of juveniles to adults that are caught each year. To see these results, use type='p' when using plot.trend(). Note this is probably not a good measure, even relatively, of the number of young produced exactly on a CES site since young birds can disperse some distance even at a relatively young age. For example, wetland sites typically have a higher productivity than drier sites since birds may congregate there to forage. Thus this measure of productivity is better thought of as a measure the number of young fledging from the wider area surrounding the site; how far this will be will depend on the site. Note also that, following Peach _et al._ (1996) and Robinson _et al._ (2007), the index is expressed in terms of the number of juveniles per adult, rather than simply the proportion of juveniles^[This is achieved by using a log rather than a logistic back-transform to create the annual indices, see Peach _et al._ (1996) for details.]

## Calculating Adult Survival

To estimate survival probabilities, we first need to extract capture histories for individual birds, we can do this for adult birds using:
```{r}
robin.ch = extract.ch(ukdata, species=10990, plots=uk_sites)
```
(The data are required in a different format, hence the need for a different extract command). Use summary() to see how many individuals we histories for
```{r}
summary(robin.ch)
```
As with all ces objects you can plot this to get an idea of what the data look like
```{r, fig.dim = c(5, 5), fig.align='center'}
plot(robin.ch, sitelist=c('417', '420', '463'))
```

Each line represents a particular capture history, grouped by site. Blue indicates occasions when those birds were captured, red when they were not; darker colours indicate more frequently occurring histories (i.e. representing more individuals). We've chosen to plot just three sites simply to make the example a bit clearer. Working from the top of the plot, the first two groups of birds were caught in each of the first three and two years respectively. The third group, were caught twice in the first year, not in the second, and again in the third. Note there are _two_ capture occasions in the first year (hence the x-axis label not being year). Several individuals caught in the fourth year on this site were caught both again in that year and in each of the subsequent three years (the dark blue bar, halfway down).

Survival probabilities for adults are estimated using function mark.ces(). This runs Program MARK (White & Burnham 1999) through the RMark package (Laake & Rexstad 2008) to fit a form of the standard CJS mark-recapture model modified to account for transients (after the manner of Pradel _et al._ 1997), see below for details^[not yet written!]. Briefly, this allows us to account for individuals that are only caught once, either because they are migrating through the area, or because they are breeding a fair distance from the nets and so are much less likely to be caught than those with nests close to the net locations.
```{r}
robin.surv = mark.ces(robin.ch)
```
(If you see the error message: Error in setwd("markfiles"): cannot change working directory, you probably need to use setwd() to change the working folder to one you have permission to write to.)

This will estimate a number of quantities, which again we can see by using summary()
```{r}
summary(robin.surv)
```
The probability of residency is, loosely, the proportion of birds caught on the site that is likely to be resident and breeding there. Adult survival rates are estimated annually and assumed to be the same across all sites (this could be relaxed by using the group= option when extracting the data and re-running mark.ces). The recapture probabilities are site-specific, but constant through time (reflecting constant effort!). In this case the summary of recapture probabilities isn't very informative, but R has identified that sites 447 and 656 have poorly estimated recapture probabilities, so we may wish exclude them, using the exclude= argument to mark.ces:
```{r}
robin.surv = mark.ces(robin.ch, exclude=c(656,447))
```
which gives similar results:
```{r}
summary(robin.surv)
```
It can also be informative to look at a graph of the annual survival estimates and site-specific recaptures, by simply :
```{r, fig.dim = c(5,5), fig.align='center'}
plot(robin.surv)
```
You can also use plot.trend as before, but with type='survival' (or 's' for short), to get the survival trend  for presentation in a paper or report.

## Site Reporting

Providing feedback to volunteers is key, and all ringers like to know how their site is doing relative to others. By harnessing the power of the RMarkdown package, R can summarise data, format it and write it directly to a word/pdf/html file. Using R's ability to subset data it is 'simple' to run a basic report for each site that operated in a year. The example does this for just two sites, but if you don't specify 'sitelist=', it'll do it for all sites operating in the year.
```{r, eval=FALSE}
sitereport(ukdata, sitelist=c(401, 420), year=2007)
```
However. Setting up the report format does take a bit of effort and care. I've provided the template that we use at the BTO as a starting point. It will look a bit daunting initially, but once you understand how it works hopefully it is more straightforward than it looks. The first thing to do is locate the template files. There are three ("CES-template.Rmd", "word_styles.docx", and "example_site.doc"), and they are in the 'exec' subfolder of the package. You can use the .libPaths() function to find were R has installed the package on your computer (note the initial period and the capital 'P') or you can grab them from the [cesr github](https://github.com/btorobrob/cesr/tree/master/exec) pages. Save them where you can easily find them and read on for a Markdown crash course...

Once you have the files, open the "example_site.doc" and familiarise yourself with its content, it contains some graphs showing how catches at this site compared to other sites, with figure captions that are specific to the site, and then some more generic explanatory text towards the end. This was all produced from "CES-template.Rmd", which is an RMarkdown file. Markdown files are simple text files that use tags to style the different elements; rather brilliantly, these tags also allow one to incorporate the output from R commands. There's a basic Markdown tutorial on the [Rstudio](https://rmarkdown.rstudio.com/lesson-1.html) site. 

Open up the Markdown file ("CES-template.Rmd"), have a look and compare it with the Word file. You should see how at least some of the elements match directly to those in the Word file. But let's work through it. The first seven lines (bounded by the three dashes '---') set-up the file as Word document. It is possible to produce pdf, html, even Powerpoint files, but we chose Word since it makes it easy to add a sentence or two of more personalised text in the explanatory notes at the end, before 'printing' it as pdf for sending to the ringer. 

The next line (starting '#') generates the title. The '#' signifies a Level 1 Heading (two '##' a Level 2 Heading, for example the next line down, and so on); we'll come on to how these are defined in a bit. The title is actually a bit of R code that pulls in the site number and year (generated within the sitereport() function). To include one line of R code, simply preface the code (in this case the paste() function) with an 'r' and enclose the whole line in backquotes ('`'); note: these _must_ be backquotes, not single quotes (on English keyboards they are often found at the top left). The following line (starting '##') prints a second level heading.

The 'chunk', or block, of lines enclosed by three backquotes (```) prints the first graph and caption. The '{r}' identifies a block of R commands, and we've indicated we don't want these commands to be printed to the file, just the output of them (that's the 'echo=FALSE' bit) and we want all the output to come together ('hold=TRUE', strictly, I suspect this may be unnecessary). The R data objects referred to in the code are generated within the sitereport() function. We then put a rule across the page (with '***'), another heading ('##'), some more R code to print the next graph, and so on.

You should be able to see how you can alter the text elements to say something more pertinent, even if only because it is in a more appropriate language! The text is styled (not unsurprisingly) according to the 'word-styles.docx', this file must sit in the same directory as the Rmd file. In it you will see words that identify each of the different header levels, styled accordingly. To change these, highlight the relevant text and right-click on the appropriate 'style' button then select "Modify..." (at least in Windows 10). Save this file, but do not change its name (or, if you do, alter the entry in the top of the '.Rmd' file to match)

Once you've altered the Markdown file, save it (you can give it a different name) and then you can run the sitereport command above. Use the template_file= argument to tell R where to find your new template, if it is in the working directory you can use just the filename, otherwise give the whole path.
```{r, eval=FALSE}
sitereport(ukdata, year=2017, template_file='new_filename')
```
Making small changes to the R code output (rather than simply the text) is probably possible, but major changes (i.e. if you need different summaries, or you want pdf output directly) will probably require altering the sitereport() function, which is beyond what we can do here, but feel free to create a copy of the function and have a go. If you get stuck drop me a line and I'll help if I can.

Good luck!

## References
**Baillie, SR** (1990) Integrated population monitoring of breeding birds in Britain and Ireland. _Ibis_ 132:151-161.

**Baillie, SR** (2001) The contribution of ringing to the conservation and management of bird populations: a review. _Ardea_ 89:S167-184.

**Berthold, P, Fliege, G, Querner, U & Winkler, H** (1986) The development of songbird populations in central Europe: analysis of trapping data. _Journal fur Ornithologie_ 127:397-437.

**Bolker, BM** (2008) _Ecological models and data in R._ Princeton University Press.

**Cave, VM, Freeman, SN, Brooks, SP, King, R & Balmer, DE** (2009) On adjusting for missed visits in the indexing of abundance from 'constant effort' ringing. _Environmental and Ecological Statistics_ 3:949-963.
 
**DeSante, DF, Burton, KM, Saracco, JF & Walker, BL** (1995) Productivity indices and survival rate estimates from MAPS, a continent-wide programme of constant-effort mist netting in North America. _Journal Applied Statistics_ 22:935-947.

**Julliard, R** (2004) Estimating the contribution of survival and recruitment to large scale population dynamics. _Animal Biodiversity & Conservation_ 27:417-426.

**Laake, J. & Rexstad, E.** (2008) RMark - an alternative approach to building linear models in MARK. In Cooch, E. & White, G.C. (eds) [Mark - a gentle introduction.](www.phidot.org/software/mark/docs/book).

**Miles, W, Freeman, SN, Harrison, NM & Balmer, DE** (2007) Measuring passerine productivity using constant effort sites: the effect of missed visits. _Ringing & Migration_ 23:231-237.

**Payton, ME, Greenstone, MH & Schenker, N** (2003) Overlapping confidence intervals or standard error intervals: What do they mean in terms of statistical significance? _Journal of Insect Science_ 3:34.

**Peach, WJ, Buckland, ST & Baillie, SR** (1996) The use of constant effort mist-netting to measure between-year changes in abundance and productivity of common passerines. _Bird Study_ 43:142-156.

**Pradel, R, Hines, JE, Lebreton, JD, & Nichols, JD** (1997) Capture-recapture survival models taking account of transients. _Biometrics_ 53:60-72. 

**Robinson, RA, Freeman, SN, Balmer, DE & Grantham, MJ** (2007) Cetti's warbler Cettia cetti: analysis of an expanding population. _Bird Study_ 54:230-235.

**Robinson, RA, Julliard, R & Saracco, JF** (2009) Constant effort: studying avian population processes using standardized ringing. _Ringing & Migration_ 24:199-204.

**Saracco, JF, DeSante, DF & Kaschube, DR** (2008) Assessing landbird monitoring programs and demographic causes of population change. _Journal of Wildlife Management_ 72:1665-1673.

**Venables, WN & Ripley, BD** (2002) _Modern applied statistics with S, 4th ed._ Springer, Berlin.

**White, GC & Burnham, KP** (1999) Program MARK: survival estimation from populations of marked animals. _Bird Study_ 46:S120-S139.

**Wood, SN** (2006) _Generalized additive models in R._ Chapman & Hall, London.

**Zuur, AF, Ieno, EN & Smith, GM** (2007) _Analyzing ecological data._ Springer, Berlin.


